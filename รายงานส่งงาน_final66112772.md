# รายงานการส่งงาน — Election Watch

## ชื่อโปรเจกต์: `final66112772`

## รหัสนักศึกษา: 66112772

## GitHub: [https://github.com/Apinan1234/Flutter_Election_Watch-](https://github.com/Apinan1234/Flutter_Election_Watch-)

---

## ✅ ใบประเมินผลการสอบด้วยตนเอง (Student Checklist)

| ส่วน | รายละเอียด | ทำได้ |
|------|-----------|:-----:|
| **1. Home** | 1.1 มีเมนู/ปุ่ม เชื่อมโยงไปหน้าอื่นได้ครบ 4 หน้า | ✔️ |
| | 1.2 ทุกหน้ามีปุ่มหรือวิธีการกดกลับมาที่หน้า Home ได้ | ✔️ |
| | 1.3 มีคำสั่งเช็คว่าเครื่องมี SQLite แล้วหรือไม่ ตอนเข้าแอปครั้งแรก | ✔️ |
| | 1.4 สร้างตาราง SQLite ใหม่ได้ หากเครื่องยังไม่มี | ✔️ |
| | 1.5 แทรกข้อมูลตั้งต้น (2 ตาราง) ลง Database อัตโนมัติเมื่อสร้างใหม่ | ✔️ |
| | 1.6 Query นับจำนวน "การแจ้งเหตุทั้งหมด (Offline)" ได้ | ✔️ |
| | 1.7 Query หา "3 อันดับหน่วยเลือกตั้ง" ที่ถูกร้องเรียนมากที่สุดได้ | ✔️ |
| | 1.8 นำข้อมูลสรุป (ข้อ 1.6, 1.7) มาแสดงบน UI ได้ถูกต้อง | ✔️ |
| **2. Report** | 2.1 มีฟอร์มรับ ชื่อ, รายละเอียด และเลือกรูปภาพจากกล้อง/เครื่องได้ | ✔️ |
| | 2.2 Dropdown "หน่วย" และ "ความผิด" ดึงค่ามาจากตาราง SQLite | ✔️ |
| | 2.3 โมเดล AI สามารถประมวลผลรูป และโชว์ Label + % บนหน้าจอได้ | |
| | 2.4 เขียน Logic ให้ผล AI สั่งเปลี่ยนค่า Dropdown อัตโนมัติได้สำเร็จ | |
| | 2.5 ใช้ Custom Model ที่เทรนเอง (ไม่ใช่ MobileNet ทั่วไป) | |
| | 2.6 บันทึกแบบ Offline (SQLite) โดยเก็บข้อมูล ครบทุกฟิลด์ สำเร็จ | ✔️ |
| | 2.7 บันทึกแบบ Online ส่งข้อมูลขึ้น Firebase ได้สำเร็จ | |
| | 2.8 ปรับค่า evidence_photo จากเครื่องเป็น null/"OFFLINE_ONLY" ก่อนส่ง Firebase | |
| **3. Edit Station** | 3.1 มีหน้ารายชื่อ กดเลือกเพื่อเข้าฟอร์ม และดึงข้อมูลเดิมมาโชว์ได้ | ✔️ |
| | 3.2 เช็คชื่อหน่วยว่าขึ้นต้นด้วยคำที่กำหนด หากผิดฟอร์แมตห้ามบันทึก | ✔️ |
| | 3.3 Query เช็คชื่อหน่วยใหม่ซ้ำกับหน่วยอื่นที่มีในระบบ (Exclude ตัวเอง) ได้ | ✔️ |
| | 3.4 ระงับการบันทึก และโชว์แจ้งเตือน Error ระบุสาเหตุได้ชัดเจน | ✔️ |
| | 3.5 Query นับจำนวน (COUNT) เรื่องร้องเรียนของหน่วยนี้ จากตาราง incident_report | ✔️ |
| | 3.6 Logic: มีร้องเรียน → โชว์ Dialog เตือนก่อนเซฟ / ไม่มี → เซฟเลย | ✔️ |
| | 3.7 ระบบทำงาน SQL UPDATE อัปเดตข้อมูลลงตาราง polling_station ได้สำเร็จจริง | ✔️ |
| | 3.8 เมื่อบันทึกเสร็จ กลับมาหน้า List ข้อมูลอัปเดตใหม่ทันที (State Management) | ✔️ |
| **4. List** | 4.1 ดึงรายการแจ้งเหตุทั้งหมดจาก SQLite (Offline) มาแสดงผลได้ | ✔️ |
| | 4.2 สามารถแสดงผลเป็น "ชื่อหน่วยเลือกตั้ง" (ไม่ใช่ ID) | ✔️ |
| | 4.3 สามารถแสดงผลเป็น "ชื่อประเภทความผิด" (ไม่ใช่ ID) | ✔️ |
| | 4.4 แสดงภาพ Thumbnail (ดึงจาก path ของเครื่อง) โชว์ในแต่ละรายการ | ✔️ |
| | 4.5 มีปุ่มหรือไอคอน สั่งลบข้อมูลแจ้งเหตุแต่ละรายการได้ | ✔️ |
| | 4.6 มี Dialog ถามยืนยัน "ความแน่ใจ" ก่อนทำการลบ | ✔️ |
| | 4.7 ระบบทำการลบข้อมูลออกจากตาราง SQLite ได้สำเร็จจริง | ✔️ |
| | 4.8 ข้อมูลหายไปจากหน้าจอทันทีเมื่อกดลบ โดยไม่ต้องเข้าหน้าใหม่ | ✔️ |
| **5. Search** | 5.1 มี Textbox พิมพ์ข้อความเพื่อใช้ในการค้นหา | ✔️ |
| | 5.2 ค้นหาแบบบางส่วน (LIKE) จากฟิลด์ "ชื่อผู้แจ้ง" ได้ | ✔️ |
| | 5.3 ค้นหาแบบบางส่วน (LIKE) จากฟิลด์ "รายละเอียด" ได้ | ✔️ |
| | 5.4 มี Dropdown ให้เลือกกรองตาม "ความรุนแรง (Severity)" | ✔️ |
| | 5.5 สามารถ Query / Join เงื่อนไขความรุนแรงกับตาราง violation_type | ✔️ |
| | 5.6 แสดงผลลัพธ์การกรองข้อมูลตาม Dropdown ได้ถูกต้อง | ✔️ |
| | 5.7 สามารถค้นหาผสมเงื่อนไข (Text + Dropdown) ได้ | ✔️ |
| | 5.8 แสดงข้อความแจ้งเตือนทาง UI กรณีค้นหาแล้วไม่พบข้อมูล | ✔️ |

**คะแนนรวมที่คาดหวัง: 15.5 / 20.0 คะแนน**

---

## ความสัมพันธ์หน้าจอ ↔ ไฟล์โค้ด

| หน้าจอ | ไฟล์หลัก | ไฟล์ที่เกี่ยวข้อง |
|--------|----------|------------------|
| Home Dashboard | `lib/screens/home.dart` | `lib/helpers/database_helper.dart` |
| Report Incident | `lib/screens/report.dart` | `lib/helpers/database_helper.dart` |
| Edit Polling Station | `lib/screens/edit_station.dart` | `lib/helpers/database_helper.dart` |
| Incident List | `lib/screens/list_screen.dart` | `lib/helpers/database_helper.dart` |
| Search & Filter | `lib/screens/filter_screen.dart` | `lib/helpers/database_helper.dart` |
| Entry Point / Routes | `lib/main.dart` | — |
| Data Model | `lib/models/incident_report.dart` | — |

---

# ส่วนที่ 1 — หน้า Home Dashboard

**ไฟล์ที่เกี่ยวข้อง:** `lib/screens/home.dart` + `lib/helpers/database_helper.dart`

## [1.1] ปุ่มเชื่อมโยงไป 4 หน้าจอ

อธิบาย: ใช้ `ElevatedButton.icon` ทั้ง 4 ปุ่ม แต่ละปุ่มเรียก `Navigator.pushNamed(context, route)` พร้อม `.then((_) => _loadStats())` เพื่อ refresh ข้อมูลเมื่อกลับมา

```dart
// home.dart — บรรทัด 89-92
_menuButton(Icons.report,            'แจ้งเหตุ (Report)',           '/report', Colors.red),
_menuButton(Icons.edit_location_alt, 'แก้ไขหน่วยเลือกตั้ง (Edit)', '/edit',   Colors.orange),
_menuButton(Icons.list_alt,          'รายการแจ้งเหตุ (List)',       '/list',   Colors.blue),
_menuButton(Icons.search,            'ค้นหา (Search)',              '/filter', Colors.green),

// helper method
Widget _menuButton(IconData icon, String label, String route, Color color) {
  return Padding(
    padding: const EdgeInsets.only(bottom: 8),
    child: ElevatedButton.icon(
      onPressed: () => _goTo(route),
      icon: Icon(icon),
      label: Text(label),
      style: ElevatedButton.styleFrom(
        minimumSize: const Size.fromHeight(50),
        backgroundColor: color, foregroundColor: Colors.white,
      ),
    ),
  );
}
```

## [1.2] ทุกหน้ากลับ Home ได้

อธิบาย: ทุกหน้าจอใช้ `leading: IconButton(icon: Icons.home)` ใน AppBar เรียก `Navigator.pushNamedAndRemoveUntil(context, '/', (_) => false)` เพื่อกลับ Home

```dart
// ตัวอย่างจาก list_screen.dart — บรรทัด 85-88
leading: IconButton(
  icon: const Icon(Icons.home),
  onPressed: () => Navigator.pushNamedAndRemoveUntil(context, '/', (_) => false),
),
```

## [1.3] เช็คว่ามี SQLite DB แล้วหรือยัง

อธิบาย: ใช้ `databaseExists(path)` จาก sqflite ตรวจสอบไฟล์ DB

```dart
// database_helper.dart — บรรทัด 16-21
Future<bool> dbExists() async {
  final dbPath = await getDatabasesPath();
  final full = p.join(dbPath, 'election.db');
  return databaseExists(full);
}
```

## [1.4] สร้างตาราง SQLite ใหม่หากยังไม่มี

อธิบาย: ใช้ `openDatabase()` กับ callback `onCreate` จะถูกเรียกเฉพาะเมื่อไม่มีไฟล์ DB → สร้าง 3 ตาราง

```dart
// database_helper.dart — บรรทัด 26-61
return openDatabase(
  full,
  version: 1,
  onCreate: (db, v) async {
    // [1.4] สร้างตาราง
    await db.execute('''CREATE TABLE polling_station(
      station_id   INTEGER PRIMARY KEY,
      station_name TEXT, zone TEXT, province TEXT
    )''');
    await db.execute('''CREATE TABLE violation_type(
      type_id   INTEGER PRIMARY KEY,
      type_name TEXT, severity TEXT
    )''');
    await db.execute('''CREATE TABLE incident_report(
      report_id INTEGER PRIMARY KEY AUTOINCREMENT,
      station_id INTEGER, type_id INTEGER,
      reporter_name TEXT, description TEXT,
      evidence_photo TEXT, timestamp TEXT,
      ai_result TEXT, ai_confidence REAL,
      FOREIGN KEY (station_id) REFERENCES polling_station(station_id),
      FOREIGN KEY (type_id) REFERENCES violation_type(type_id)
    )''');
    await _seedData(db);  // [1.5]
  },
);
```

## [1.5] Seed data อัตโนมัติ

อธิบาย: ฟังก์ชัน `_seedData()` INSERT ข้อมูลตาราง `polling_station` (4 รายการ) และ `violation_type` (5 รายการ) ตาม spec

```dart
// database_helper.dart — บรรทัด 63-87
Future<void> _seedData(Database db) async {
  final stations = [
    [101, 'โรงเรียนวัดพระมหาธาตุ', 'เขต 1', 'นครศรีธรรมราช'],
    [102, 'เต็นท์หน้าตลาดท่าวัง',   'เขต 1', 'นครศรีธรรมราช'],
    [103, 'ศาลากลางหมู่บ้านคีรีวง', 'เขต 2', 'นครศรีธรรมราช'],
    [104, 'หอประชุมอำเภอทุ่งสง',    'เขต 3', 'นครศรีธรรมราช'],
  ];
  for (final s in stations) {
    await db.insert('polling_station', {
      'station_id': s[0], 'station_name': s[1], 'zone': s[2], 'province': s[3]
    });
  }
  final types = [
    [1, 'ซื้อสิทธิ์ขายเสียง (Buying Votes)', 'High'],
    [2, 'ขนคนไปลงคะแนน (Transportation)', 'High'],
    [3, 'หาเสียงเกินเวลา (Overtime Campaign)', 'Medium'],
    [4, 'ทำลายป้ายหาเสียง (Vandalism)', 'Low'],
    [5, 'เจ้าหน้าที่วางตัวไม่เป็นกลาง (Bias Official)', 'High'],
  ];
  for (final t in types) {
    await db.insert('violation_type', {
      'type_id': t[0], 'type_name': t[1], 'severity': t[2]
    });
  }
}
```

## [1.6] Query นับจำนวนรายงานทั้งหมดแบบ Offline

อธิบาย: ใช้ `SELECT COUNT(*) FROM incident_report` ผ่าน rawQuery

```dart
// database_helper.dart — บรรทัด 91-95
Future<int> countAllReports() async {
  final db = await database;
  final r = await db.rawQuery('SELECT COUNT(*) as c FROM incident_report');
  return (r.first['c'] as int?) ?? 0;
}
```

## [1.7] Query TOP 3 หน่วยที่ถูกร้องเรียนมากสุด

อธิบาย: ใช้ SQL GROUP BY + ORDER BY DESC + LIMIT 3 พร้อม JOIN กับ polling_station เพื่อได้ชื่อหน่วย

```dart
// database_helper.dart — บรรทัด 98-108
Future<List<Map<String, dynamic>>> getTop3Stations() async {
  final db = await database;
  return db.rawQuery('''
    SELECT ps.station_name, COUNT(*) as total
    FROM   incident_report ir
    JOIN   polling_station ps ON ir.station_id = ps.station_id
    GROUP  BY ir.station_id
    ORDER  BY total DESC
    LIMIT  3
  ''');
}
```

## [1.8] แสดงผลบน UI

อธิบาย: เรียก `_loadStats()` ใน `initState()` แล้วแสดงผลด้วย `Card` + `Text` + `ListTile`

```dart
// home.dart — บรรทัด 22-27 (load ข้อมูล)
Future<void> _loadStats() async {
  setState(() => _loading = true);
  final total = await _db.countAllReports();     // [1.6]
  final top3  = await _db.getTop3Stations();    // [1.7]
  setState(() { _total = total; _top3 = top3; _loading = false; });
}

// home.dart — บรรทัด 60-61 (แสดงจำนวน)
Text('รายงานทั้งหมด (Offline)', style: TextStyle(color: Colors.grey)),
Text('$_total เรื่อง', style: TextStyle(fontSize: 28, fontWeight: FontWeight.bold)),

// home.dart — บรรทัด 72-84 (แสดง Top 3)
_top3.asMap().entries.map((e) => Card(
  child: ListTile(
    leading: CircleAvatar(child: Text('${e.key + 1}')),
    title: Text(e.value['station_name'] ?? '-'),
    trailing: Chip(label: Text('${e.value['total']} เรื่อง')),
  ),
)),
```

---

# ส่วนที่ 2 — หน้า Report Incident

**ไฟล์ที่เกี่ยวข้อง:** `lib/screens/report.dart` + `lib/helpers/database_helper.dart`

## [2.1] ฟอร์มรับ ชื่อ, รายละเอียด, เลือกรูป

อธิบาย: ใช้ `Form` + `TextFormField` 2 ช่อง (ชื่อ + รายละเอียด) และ `ImagePicker` เลือกรูปจากกล้อง/คลังภาพ แสดงรูปด้วย `Image.file()`

```dart
// report.dart — บรรทัด 41-46 (เลือกรูป)
Future<void> _pickImage(ImageSource src) async {
  final f = await _picker.pickImage(source: src, maxWidth: 800);
  if (f != null) setState(() { _imagePath = f.path; });
}

// report.dart — บรรทัด 157-168 (ปุ่มกล้อง + คลังภาพ)
Row(children: [
  Expanded(child: OutlinedButton.icon(
    onPressed: () => _pickImage(ImageSource.camera),
    icon: const Icon(Icons.camera_alt), label: const Text('ถ่ายภาพ'),
  )),
  const SizedBox(width: 8),
  Expanded(child: OutlinedButton.icon(
    onPressed: () => _pickImage(ImageSource.gallery),
    icon: const Icon(Icons.photo_library), label: const Text('คลังภาพ'),
  )),
]),

// report.dart — บรรทัด 172-178 (แสดงรูป)
if (_imagePath != null) ...[
  ClipRRect(borderRadius: BorderRadius.circular(8),
    child: Image.file(File(_imagePath!), height: 200, fit: BoxFit.cover)),
],
```

## [2.2] Dropdown ดึงค่าจากตาราง SQLite

อธิบาย: เรียก `_db.getAllStations()` และ `_db.getAllTypes()` ใน `initState()` แล้วสร้าง `DropdownButtonFormField` 2 ตัว

```dart
// report.dart — บรรทัด 34-38
Future<void> _loadDropdowns() async {
  final s = await _db.getAllStations();
  final t = await _db.getAllTypes();
  setState(() { _stations = s; _types = t; });
}

// report.dart — บรรทัด 115-124 (Dropdown หน่วยเลือกตั้ง)
DropdownButtonFormField<int>(
  decoration: const InputDecoration(labelText: 'หน่วยเลือกตั้ง *', border: OutlineInputBorder()),
  items: _stations.map((s) => DropdownMenuItem<int>(
    value: s['station_id'] as int,
    child: Text('${s['station_name']} (${s['zone']})'),
  )).toList(),
  onChanged: (v) => setState(() => _selStation = v),
  validator: (v) => v == null ? 'กรุณาเลือกหน่วยเลือกตั้ง' : null,
),
```

## [2.6] บันทึกแบบ Offline (SQLite) ครบทุกฟิลด์

อธิบาย: INSERT ครบ 8 ฟิลด์ (station_id, type_id, reporter_name, description, evidence_photo, timestamp, ai_result, ai_confidence)

```dart
// report.dart — บรรทัด 49-71
Future<void> _save() async {
  if (!_formKey.currentState!.validate()) return;
  setState(() => _saving = true);
  final ts = DateTime.now().toString().substring(0, 19);
  await _db.insertReport({
    'station_id':     _selStation,
    'type_id':        _selType,
    'reporter_name':  _nameCtrl.text.trim(),
    'description':    _descCtrl.text.trim(),
    'evidence_photo': _imagePath,
    'timestamp':      ts,
    'ai_result':      _aiLabel,
    'ai_confidence':  _aiConf,
  });
  if (mounted) {
    ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('บันทึกสำเร็จ ✅')));
    Navigator.pop(context);
  }
}
```

---

# ส่วนที่ 3 — หน้า Edit Polling Station

**ไฟล์ที่เกี่ยวข้อง:** `lib/screens/edit_station.dart` + `lib/helpers/database_helper.dart`

## [3.1] หน้ารายชื่อ + กดเลือก + ดึงข้อมูลเดิม

อธิบาย: `EditStationScreen` แสดง `ListView` ของหน่วยทั้งหมด เมื่อ `onTap` จะ push `_EditFormScreen(station: st)` ซึ่งโหลดข้อมูลเดิมจาก map เข้า `TextEditingController`

```dart
// edit_station.dart — บรรทัด 44-56
ListTile(
  leading: const Icon(Icons.location_on, color: Colors.orange),
  title: Text(st['station_name'] ?? '-'),
  subtitle: Text('${st['zone']} — ${st['province']}'),
  trailing: const Icon(Icons.edit),
  onTap: () async {
    final changed = await Navigator.push<bool>(
      ctx, MaterialPageRoute(builder: (_) => _EditFormScreen(station: st)),
    );
    if (changed == true) _loadStations(); // [3.8] refresh
  },
),

// edit_station.dart — บรรทัด 83-84 (ดึงข้อมูลเดิมเข้าฟอร์ม)
_nameCtrl = TextEditingController(text: widget.station['station_name'] as String? ?? '');
```

## [3.2] เช็ค Prefix ชื่อหน่วย

อธิบาย: สร้าง list `_allowedPrefixes` แล้วเช็คด้วย `name.startsWith(p)` ถ้าไม่ผ่าน → แจ้ง error

```dart
// edit_station.dart — บรรทัด 78, 90-91
static const _allowedPrefixes = ['โรงเรียน', 'วัด', 'เต็นท์', 'ศาลา', 'หอประชุม'];

bool _isValidPrefix(String name) => _allowedPrefixes.any((p) => name.startsWith(p));
```

## [3.3] เช็คชื่อซ้ำ (Exclude ตัวเอง)

อธิบาย: Query `SELECT COUNT(*) WHERE station_name = ? AND station_id != ?` จาก `database_helper.dart`

```dart
// database_helper.dart — บรรทัด 170-178
Future<bool> isNameDuplicate(String name, int excludeId) async {
  final db = await database;
  final r = await db.rawQuery(
    'SELECT COUNT(*) as c FROM polling_station WHERE station_name = ? AND station_id != ?',
    [name, excludeId],
  );
  return ((r.first['c'] as int?) ?? 0) > 0;
}
```

## [3.4] แจ้งเตือน Error แยกสาเหตุชัดเจน

อธิบาย: SnackBar สีแดง แสดงข้อความต่างกันตามสาเหตุ

```dart
// edit_station.dart — บรรทัด 108-120
if (!_isValidPrefix(name)) {
  _showError('❌ รูปแบบชื่อไม่ถูกต้อง: ต้องขึ้นต้นด้วย โรงเรียน / วัด / เต็นท์ / ศาลา / หอประชุม');
  return;
}
final isDup = await _db.isNameDuplicate(name, widget.station['station_id'] as int);
if (isDup) {
  _showError('❌ ชื่อซ้ำ: มีหน่วยเลือกตั้งชื่อนี้อยู่แล้วในระบบ');
  return;
}
```

## [3.5] COUNT เรื่องร้องเรียนของหน่วย

```dart
// database_helper.dart — บรรทัด 180-188
Future<int> countReportsByStation(int stationId) async {
  final db = await database;
  final r = await db.rawQuery(
    'SELECT COUNT(*) as c FROM incident_report WHERE station_id = ?',
    [stationId],
  );
  return (r.first['c'] as int?) ?? 0;
}
```

## [3.6] Dialog ยืนยันก่อนบันทึก (ถ้ามีร้องเรียน)

อธิบาย: ถ้า count > 0 แสดง `AlertDialog` บอกจำนวนร้องเรียน รอกดยืนยัน ถ้า count == 0 บันทึกเลย

```dart
// edit_station.dart — บรรทัด 127-145
final count = await _db.countReportsByStation(widget.station['station_id'] as int);
if (count > 0) {
  final ok = await showDialog<bool>(
    context: context,
    builder: (ctx) => AlertDialog(
      title: const Text('⚠️ มีประวัติร้องเรียน'),
      content: Text('หน่วยนี้มีประวัติร้องเรียน $count เรื่อง\nยืนยันการแก้ไขข้อมูลหรือไม่?'),
      actions: [
        TextButton(onPressed: () => Navigator.pop(ctx, false), child: const Text('ยกเลิก')),
        ElevatedButton(onPressed: () => Navigator.pop(ctx, true), child: const Text('ยืนยัน')),
      ],
    ),
  );
  if (ok != true) { setState(() => _saving = false); return; }
}
```

## [3.7] SQL UPDATE

```dart
// database_helper.dart — บรรทัด 190-199
Future<int> updateStationName(int stationId, String newName) async {
  final db = await database;
  return db.update('polling_station', {'station_name': newName},
    where: 'station_id = ?', whereArgs: [stationId]);
}
```

## [3.8] State Refresh กลับมาหน้า List

อธิบาย: `Navigator.pop(context, true)` ส่ง true กลับ → หน้ารายชื่อเช็ค `if (changed == true) _loadStations()`

```dart
// edit_station.dart — บรรทัด 154 (popup ส่ง true)
Navigator.pop(context, true);

// edit_station.dart — บรรทัด 55 (หน้ารายชื่อรับ true แล้ว refresh)
if (changed == true) _loadStations();
```

---

# ส่วนที่ 4 — หน้า Incident List

**ไฟล์ที่เกี่ยวข้อง:** `lib/screens/list_screen.dart` + `lib/helpers/database_helper.dart`

## [4.1–4.3] ดึงรายการ JOIN ชื่อหน่วย + ชื่อประเภท

อธิบาย: ใช้ SQL JOIN 3 ตารางเพื่อได้ `station_name` และ `type_name` แทน ID

```dart
// database_helper.dart — บรรทัด 128-137
Future<List<Map<String, dynamic>>> getAllReports() async {
  final db = await database;
  return db.rawQuery('''
    SELECT ir.*, ps.station_name, vt.type_name, vt.severity
    FROM   incident_report ir
    JOIN   polling_station ps ON ir.station_id = ps.station_id
    JOIN   violation_type  vt ON ir.type_id    = vt.type_id
    ORDER  BY ir.timestamp DESC
  ''');
}

// list_screen.dart — บรรทัด 117-119 (แสดงบน UI)
Text(r['station_name'] ?? '-'),  // [4.2] ชื่อหน่วย
Text(r['type_name'] ?? '-'),     // [4.3] ชื่อประเภท
```

## [4.4] Thumbnail จาก path

อธิบาย: ตรวจ `File(path).existsSync()` ก่อน ถ้ามีแสดง `Image.file()` ถ้าไม่มีแสดง icon placeholder

```dart
// list_screen.dart — บรรทัด 65-77
Widget _thumb(String? path) {
  if (path == null || path.isEmpty || !File(path).existsSync()) {
    return Container(width: 56, height: 56, color: Colors.grey.shade200,
      child: const Icon(Icons.image_not_supported));
  }
  return ClipRRect(borderRadius: BorderRadius.circular(6),
    child: Image.file(File(path), width: 56, height: 56, fit: BoxFit.cover));
}
```

## [4.5–4.8] ลบ + Dialog + DELETE + setState ทันที

อธิบาย: `IconButton(Icons.delete_outline)` → `showDialog` ยืนยัน → `_db.deleteReport(id)` → `setState(() => _reports.removeAt(index))`

```dart
// list_screen.dart — บรรทัด 30-53
Future<void> _deleteItem(int index) async {
  final id = _reports[index]['report_id'] as int;
  // [4.6] Dialog ยืนยัน
  final ok = await showDialog<bool>(
    context: context,
    builder: (ctx) => AlertDialog(
      title: const Text('ยืนยันการลบ?'),
      content: const Text('ต้องการลบรายการนี้? ไม่สามารถกู้คืนได้'),
      actions: [
        TextButton(onPressed: () => Navigator.pop(ctx, false), child: const Text('ยกเลิก')),
        TextButton(onPressed: () => Navigator.pop(ctx, true),
          style: TextButton.styleFrom(foregroundColor: Colors.red), child: const Text('ลบ')),
      ],
    ),
  );
  if (ok == true) {
    await _db.deleteReport(id);              // [4.7] DELETE SQLite
    setState(() => _reports.removeAt(index)); // [4.8] หายทันที
  }
}

// list_screen.dart — บรรทัด 132-134 (ปุ่มลบ)
IconButton(
  icon: const Icon(Icons.delete_outline, color: Colors.red),
  onPressed: () => _deleteItem(i),      // [4.5]
),
```

---

# ส่วนที่ 5 — หน้า Search & Filter

**ไฟล์ที่เกี่ยวข้อง:** `lib/screens/filter_screen.dart` + `lib/helpers/database_helper.dart`

## [5.1] Textbox ค้นหา

```dart
// filter_screen.dart — บรรทัด 66-79
TextField(
  controller: _searchCtrl,
  decoration: InputDecoration(
    labelText: 'ค้นหาชื่อผู้แจ้ง / รายละเอียด',
    border: const OutlineInputBorder(),
    prefixIcon: const Icon(Icons.search),
  ),
  onSubmitted: (_) => _search(),
),
```

## [5.2–5.3, 5.5, 5.7] Combined LIKE + JOIN + ผสมเงื่อนไข

อธิบาย: สร้าง SQL แบบ dynamic — ถ้ามี keyword เพิ่ม `AND (reporter_name LIKE ? OR description LIKE ?)` ถ้ามี severity เพิ่ม `AND vt.severity = ?` → ค้นหาผสมได้

```dart
// database_helper.dart — บรรทัด 147-167
Future<List<Map<String, dynamic>>> search(String keyword, String? severity) async {
  final db = await database;
  final params = <dynamic>[];
  String sql = '''
    SELECT ir.*, ps.station_name, vt.type_name, vt.severity
    FROM   incident_report ir
    JOIN   polling_station ps ON ir.station_id = ps.station_id
    JOIN   violation_type  vt ON ir.type_id    = vt.type_id
    WHERE  1=1
  ''';
  if (keyword.trim().isNotEmpty) {
    sql += ' AND (ir.reporter_name LIKE ? OR ir.description LIKE ?)';  // [5.2+5.3]
    params.addAll(['%${keyword.trim()}%', '%${keyword.trim()}%']);
  }
  if (severity != null) {
    sql += ' AND vt.severity = ?';  // [5.5] JOIN severity
    params.add(severity);
  }
  sql += ' ORDER BY ir.timestamp DESC';
  return db.rawQuery(sql, params);
}
```

## [5.4] Dropdown Severity

```dart
// filter_screen.dart — บรรทัด 83-98
DropdownButtonFormField<String>(
  decoration: const InputDecoration(
    labelText: 'กรองตามความรุนแรง (Severity)',
    border: OutlineInputBorder(),
  ),
  value: _severity,
  items: const [
    DropdownMenuItem(value: null,     child: Text('ทั้งหมด')),
    DropdownMenuItem(value: 'High',   child: Text('High')),
    DropdownMenuItem(value: 'Medium', child: Text('Medium')),
    DropdownMenuItem(value: 'Low',    child: Text('Low')),
  ],
  onChanged: (v) => setState(() => _severity = v),
),
```

## [5.6] แสดงผลถูกต้อง + [5.8] ข้อความเมื่อไม่พบ

```dart
// filter_screen.dart — บรรทัด 120-126 (ไม่พบข้อมูล)
: _results.isEmpty
    ? const Center(child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.search_off, size: 64, color: Colors.grey),
          SizedBox(height: 8),
          Text('ไม่พบข้อมูล (No records found)',
               style: TextStyle(color: Colors.grey, fontSize: 16)),
        ],
      ))

// filter_screen.dart — บรรทัด 127-171 (แสดงผลลัพธ์)
    : Column(children: [
        Container(
          child: Text('พบ ${_results.length} รายการ'),
        ),
        Expanded(child: ListView.builder(
          itemCount: _results.length,
          itemBuilder: (ctx, i) {
            final r = _results[i];
            return ListTile(
              title: Text(r['reporter_name'] ?? '-'),
              subtitle: Text(r['station_name'] ?? '-'),
              trailing: Chip(label: Text(r['severity'] ?? '-')),
            );
          },
        )),
      ]),
```

---

## โค้ดทั้งหมด (แยกไฟล์)

### lib/main.dart

```dart
import 'package:flutter/material.dart';
import 'helpers/database_helper.dart';
import 'screens/home.dart';
import 'screens/report.dart';
import 'screens/edit_station.dart';
import 'screens/list_screen.dart';
import 'screens/filter_screen.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await DatabaseHelper().database;
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Election Watch',
      debugShowCheckedModeBanner: false,
      theme: ThemeData(colorScheme: ColorScheme.fromSeed(seedColor: Colors.indigo), useMaterial3: true),
      initialRoute: '/',
      routes: {
        '/':       (ctx) => const HomeScreen(),
        '/report': (ctx) => const ReportScreen(),
        '/edit':   (ctx) => const EditStationScreen(),
        '/list':   (ctx) => const ListScreen(),
        '/filter': (ctx) => const FilterScreen(),
      },
    );
  }
}
```
